<!DOCTYPE html>
<html>
<head>
    <title>AR-RTI 촬영 보조 웹 앱</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- A-Frame for AR and 3D -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* AR Scene을 화면 전체에 꽉 채웁니다. */
        .ar-scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; /* UI 뒤로 보냅니다. */
        }
        /* 중앙 십자가 UI */
        .crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border: 2px solid white;
            border-radius: 50%;
            transition: all 0.2s ease-in-out;
            pointer-events: none; /* 십자가가 터치를 방해하지 않도록 합니다. */
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background-color: white;
            transition: all 0.2s ease-in-out;
        }
        .crosshair::before { /* 수평선 */
            left: 50%;
            top: calc(50% - 1px);
            width: 12px;
            height: 2px;
            transform: translateX(-50%);
        }
        .crosshair::after { /* 수직선 */
            left: calc(50% - 1px);
            top: 50%;
            width: 2px;
            height: 12px;
            transform: translateY(-50%);
        }
        /* Lock-on 상태 스타일 */
        .crosshair.locked-on {
            border-color: #4ade80; /* green-400 */
            transform: translate(-50%, -50%) scale(1.5);
        }
        .crosshair.locked-on::before, .crosshair.locked-on::after {
            background-color: #4ade80;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- ===== 설정 화면 ===== -->
    <div id="settings-screen" class="p-6 max-w-md mx-auto bg-white rounded-xl shadow-md space-y-4 mt-8">
        <h1 class="text-2xl font-bold text-gray-800">RTI 돔 설정</h1>
        
        <div>
            <label for="domeType" class="block text-sm font-medium text-gray-700">돔 타입</label>
            <select id="domeType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="free">자유 배치</option>
                <option value="geodesic">3v 지오데식 (미구현)</option>
            </select>
        </div>

        <div>
            <label for="radius" class="block text-sm font-medium text-gray-700">돔 반지름 (mm)</label>
            <input type="number" id="radius" value="300" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
        </div>

        <div>
            <label for="torchDuration" class="block text-sm font-medium text-gray-700">손전등 지속 시간 (초)</label>
            <input type="number" id="torchDuration" value="2" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
        </div>
        
        <div id="free-placement-options">
            <div>
                <label for="azimuths" class="block text-sm font-medium text-gray-700">방위각 개수</label>
                <select id="azimuths" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                    <option>1</option> <option>2</option> <option>3</option> <option>4</option>
                    <option>6</option> <option selected>8</option> <option>12</option>
                </select>
            </div>
            <div class="mt-4">
                <label for="elevations" class="block text-sm font-medium text-gray-700">고도각 (콤마로 구분)</label>
                <input type="text" id="elevations" placeholder="예: 15, 30, 45, 60, 75" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
            </div>
        </div>
        
        <button id="start-ar-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-transform transform hover:scale-105">
            AR 시작
        </button>
    </div>

    <!-- ===== AR 화면 ===== -->
    <div id="ar-screen" class="hidden">
        <!-- A-Frame AR Scene -->
        <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;" class="ar-scene" vr-mode-ui="enabled: false">
            <!-- 
                중요: 'url' 속성을 직접 생성한 marker.patt 파일 경로로 변경해야 합니다.
                자세한 내용은 marker-guide.md 파일을 참고하세요.
                아래는 기본 히로(hiro) 마커 예시입니다.
            -->
            <a-marker type="pattern" url="marker.patt">
                <!-- 돔, 조명, 타겟이 이 안에 생성됩니다. -->
                <a-entity id="dome-container" rti-dome-manager></a-entity>
            </a-marker>
            <a-entity camera></a-entity>
        </a-scene>

        <!-- AR 화면 위 UI -->
        <div class="crosshair" id="crosshair"></div>
        <div class="fixed top-4 right-4 space-x-2">
            <button id="torch-toggle" class="bg-gray-800 bg-opacity-50 text-white font-semibold py-2 px-4 rounded-md shadow-md">손전등 사용</button>
        </div>
        <div class="fixed bottom-4 right-4">
             <button id="download-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg">데이터 다운로드</button>
        </div>
    </div>

    <script>
        // A-Frame 컴포넌트: 3D 돔과 관련된 모든 로직을 관리합니다.
        AFRAME.registerComponent('rti-dome-manager', {
            init: function () {
                this.PI = Math.PI;
                this.loggedData = [];
                this.isLockedOn = false;
                this.audioContext = null;
                this.videoTrack = null;
                
                // UI에서 설정값 가져오기
                const radiusMm = parseFloat(document.getElementById('radius').value) || 300;
                this.radius = radiusMm / 1000.0; // mm를 미터(m)로 변환
                const numAzimuths = parseInt(document.getElementById('azimuths').value, 10) || 8;
                let elevationsStr = document.getElementById('elevations').value;
                if (!elevationsStr) {
                    elevationsStr = "15,30,45,60,75"; // 기본값
                }
                const elevations = elevationsStr.split(',').map(e => parseFloat(e.trim())).filter(e => !isNaN(e));

                // 돔 가이드 생성
                const domeGuide = document.createElement('a-sphere');
                domeGuide.setAttribute('radius', this.radius);
                domeGuide.setAttribute('color', 'black');
                domeGuide.setAttribute('material', 'opacity: 0.2; side: double; transparent: true;');
                domeGuide.setAttribute('geometry', 'thetaLength', 180); // 반구
                this.el.appendChild(domeGuide);
                
                // 중앙 타겟 생성
                const target = document.createElement('a-cylinder');
                target.setAttribute('radius', this.radius * 0.05);
                target.setAttribute('height', '0.001');
                target.setAttribute('color', 'grey');
                target.setAttribute('material', 'opacity: 0.8');
                target.setAttribute('position', '0 0 0');
                target.setAttribute('rotation', '90 0 0'); // 바닥에 눕힘
                this.el.appendChild(target);
                this.target3D = target.object3D; // 나중에 거리 계산에 사용

                // 조명 마커 생성
                const azimuthStep = 360 / numAzimuths;
                for (let i = 0; i < numAzimuths; i++) {
                    const azimuth = i * azimuthStep;
                    for (const elevation of elevations) {
                        const theta = (azimuth * this.PI) / 180;
                        const phi = ((90 - elevation) * this.PI) / 180;
                        
                        const x = this.radius * Math.sin(phi) * Math.cos(theta);
                        const y = this.radius * Math.cos(phi);
                        const z = this.radius * Math.sin(phi) * Math.sin(theta);
                        
                        const lightMarker = document.createElement('a-sphere');
                        lightMarker.setAttribute('radius', this.radius * 0.04); // 크기 4%
                        lightMarker.setAttribute('color', 'yellow');
                        lightMarker.setAttribute('material', 'opacity: 0.8');
                        lightMarker.setAttribute('position', `${x} ${y} ${z}`);
                        this.el.appendChild(lightMarker);
                    }
                }
                
                // 오디오 컨텍스트 초기화 (사용자 상호작용 시)
                window.addEventListener('click', () => {
                    if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }, { once: true });
            },

            // 매 프레임마다 호출되는 함수
            tick: function () {
                const crosshair = document.getElementById('crosshair');
                if (!this.el.sceneEl.camera) return;

                const camera = this.el.sceneEl.camera;
                const cameraPosition = new THREE.Vector3();
                camera.getWorldPosition(cameraPosition);

                const targetPosition = new THREE.Vector3();
                this.target3D.getWorldPosition(targetPosition);

                const distance = cameraPosition.distanceTo(targetPosition);
                
                const wasLockedOn = this.isLockedOn;
                this.isLockedOn = distance < this.radius * 0.1; // 10% 이내 거리

                if (this.isLockedOn && !wasLockedOn) {
                    crosshair.classList.add('locked-on');
                    this.playBeep();
                    this.logData(cameraPosition);
                } else if (!this.isLockedOn && wasLockedOn) {
                    crosshair.classList.remove('locked-on');
                }
            },
            
            playBeep: function() {
                if (!this.audioContext) return;
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime); // A5 note
                gainNode.gain.setValueAtTime(0.5, this.audioContext.currentTime);
                
                gainNode.gain.exponentialRampToValueAtTime(0.0001, this.audioContext.currentTime + 0.1);
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.1);
            },
            
            logData: function(cameraPosition) {
                const timestamp = new Date().toISOString();
                const pos = cameraPosition;
                const logEntry = `${timestamp}, X:${pos.x.toFixed(3)}, Y:${pos.y.toFixed(3)}, Z:${pos.z.toFixed(3)}`;
                this.loggedData.push(logEntry);
                console.log("Data logged:", logEntry);
            },
            
            getLoggedData: function() {
                return this.loggedData;
            }
        });

        // --- 메인 JavaScript 로직 ---
        document.addEventListener('DOMContentLoaded', () => {
            const settingsScreen = document.getElementById('settings-screen');
            const arScreen = document.getElementById('ar-screen');
            const startArBtn = document.getElementById('start-ar-btn');
            const downloadBtn = document.getElementById('download-btn');
            const torchToggle = document.getElementById('torch-toggle');
            
            let videoTrack = null;

            startArBtn.addEventListener('click', () => {
                settingsScreen.classList.add('hidden');
                arScreen.classList.remove('hidden');
                
                // AR.js가 카메라를 초기화할 시간을 줍니다.
                setTimeout(() => {
                    const stream = document.querySelector('video')?.srcObject;
                    if (stream) {
                        videoTrack = stream.getVideoTracks()[0];
                    }
                }, 2000);
            });

            // 손전등 토글 로직
            let torchOn = false;
            torchToggle.addEventListener('click', async () => {
                if (videoTrack) {
                    try {
                        await videoTrack.applyConstraints({
                            advanced: [{ torch: !torchOn }]
                        });
                        torchOn = !torchOn;
                        torchToggle.textContent = torchOn ? '손전등 끄기' : '손전등 켜기';
                    } catch (err) {
                        console.error('Torch not supported or error:', err);
                        alert('이 브라우저/기기에서는 손전등을 지원하지 않습니다.');
                    }
                }
            });
            
            // 데이터 다운로드 로직
            downloadBtn.addEventListener('click', () => {
                const domeContainer = document.getElementById('dome-container');
                const manager = domeContainer.components['rti-dome-manager'];
                const data = manager.getLoggedData();
                
                if (data.length === 0) {
                    alert('기록된 데이터가 없습니다.');
                    return;
                }
                
                const header = "Timestamp,CameraPosX,CameraPosY,CameraPosZ\n";
                const csvContent = header + data.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `rti_log_${new Date().getTime()}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
</body>
</html>
